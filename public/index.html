<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Life in Weeks</title>
  <style>
    /* --- Global Reset & Base Styling --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #fafafa;
      color: #333;
      line-height: 1.6;
      position: relative;
    }
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 0 20px;
    }
    h1, h2, h3 {
      font-weight: 600;
      margin-bottom: 1rem;
    }
    button {
      background-color: #4361ee;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }
    button:hover {
      background-color: #3a56d4;
    }
    button:active {
      transform: translateY(1px);
    }
    
    /* --- Intro Section --- */
    .intro-section {
      text-align: center;
      max-width: 700px;
      margin: 2rem auto;
      padding: 2rem;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .intro-section h1 {
      margin-bottom: 1rem;
      font-size: 2.2rem;
      color: #333;
    }
    .intro-section p {
      color: #555;
      margin-bottom: 1.5rem;
    }
    .intro-highlight {
      color: #4361ee;
      font-weight: 600;
    }
    .intro-visual {
      display: block;
      margin: 1.5rem auto;
      height: 100px;
      background-color: #f5f7ff;
      border-radius: 8px;
      position: relative;
    }
    .intro-visual::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 30%;
      height: 100%;
      background-color: #4361ee;
      opacity: 0.3;
      border-radius: 8px 0 0 8px;
    }
    
    /* --- Authentication UI --- */
    #authContainer {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      max-width: 400px;
      margin: 2rem auto;
      text-align: center;
    }
    #authContainer h1 { 
      margin-bottom: 1.5rem; 
      color: #333;
    }
    #authContainer input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 1rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    #authContainer input:focus {
      outline: none;
      border-color: #4361ee;
    }
    #authContainer button {
      width: 100%;
      margin-top: 0.5rem;
      padding: 12px;
      font-size: 16px;
    }
    .toggle-link { 
      margin-top: 1rem; 
      color: #4361ee; 
      text-decoration: none; 
      cursor: pointer; 
      font-size: 14px;
    }
    .toggle-link:hover {
      text-decoration: underline;
    }
    
    /* --- Main Life Tracker UI --- */
    #gridContainer { 
      display: none; 
      margin: 2rem auto;
      position: relative;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    #gridContainer h2 { 
      margin-bottom: 1.5rem;
      text-align: center;
      color: #333;
    }
    .grid-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    #logoutButton {
      background-color: #f44336;
    }
    #logoutButton:hover {
      background-color: #e53935;
    }
    
    /* Preset menu styling */
    #presetMenu {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #presetSelect { 
      padding: 10px 12px; 
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    
    #gridArea {
      display: grid;
      grid-template-areas: "corner xAxis" "yAxis grid";
      grid-template-columns: auto 1fr;
      grid-template-rows: auto 1fr;
      border: 1px solid #eaeaea;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
    }
    #corner {
      grid-area: corner;
      width: 60px;
      height: 30px;
      background: #f8f9fa;
      border-bottom: 1px solid #eaeaea;
      border-right: 1px solid #eaeaea;
    }
    #xAxis {
      grid-area: xAxis;
      display: grid;
      /* Match the lifeGrid column structure with month gaps */
      grid-template-columns: 
        repeat(4, 1fr) 6px  /* Jan: 4 weeks + gap */
        repeat(4, 1fr) 6px  /* Feb: 4 weeks + gap */
        repeat(5, 1fr) 6px  /* Mar: 5 weeks + gap */
        repeat(4, 1fr) 6px  /* Apr: 4 weeks + gap */
        repeat(4, 1fr) 6px  /* May: 4 weeks + gap */
        repeat(5, 1fr) 6px  /* Jun: 5 weeks + gap */
        repeat(4, 1fr) 6px  /* Jul: 4 weeks + gap */
        repeat(4, 1fr) 6px  /* Aug: 4 weeks + gap */
        repeat(5, 1fr) 6px  /* Sep: 5 weeks + gap */
        repeat(4, 1fr) 6px  /* Oct: 4 weeks + gap */
        repeat(4, 1fr) 6px  /* Nov: 4 weeks + gap */
        repeat(5, 1fr);     /* Dec: 5 weeks (no gap at end) */
      border-bottom: 1px solid #eaeaea;
    }
    #xAxis .month-label {
      text-align: center;
      font-size: 12px;
      border-right: 1px solid #eaeaea;
      background: #f8f9fa;
      padding: 6px 0;
      color: #555;
    }
    #yAxis {
      grid-area: yAxis;
      display: grid;
      /* Match the lifeGrid row structure with decade gaps */
      grid-template-rows: 
        repeat(10, 1fr) 10px  /* Decade 1: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 2: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 3: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 4: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 5: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 6: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 7: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 8: 10 years + gap */
        repeat(10, 1fr);      /* Decade 9: 10 years (no gap at end) */
      border-right: 1px solid #eaeaea;
    }
    #yAxis .decade-label {
      text-align: right;
      font-size: 12px;
      padding-right: 10px;
      border-bottom: 1px solid #eaeaea;
      background: #f8f9fa;
      line-height: 1;
      color: #555;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }
    #grid { 
      grid-area: grid; 
      overflow: auto;
      border-radius: 0 0 8px 0;
    }
    #lifeGrid {
      display: grid;
      /* Create enhanced grid with visual gaps using CSS custom properties */
      grid-template-columns: 
        repeat(4, 1fr) 6px  /* Jan: 4 weeks + gap */
        repeat(4, 1fr) 6px  /* Feb: 4 weeks + gap */
        repeat(5, 1fr) 6px  /* Mar: 5 weeks + gap */
        repeat(4, 1fr) 6px  /* Apr: 4 weeks + gap */
        repeat(4, 1fr) 6px  /* May: 4 weeks + gap */
        repeat(5, 1fr) 6px  /* Jun: 5 weeks + gap */
        repeat(4, 1fr) 6px  /* Jul: 4 weeks + gap */
        repeat(4, 1fr) 6px  /* Aug: 4 weeks + gap */
        repeat(5, 1fr) 6px  /* Sep: 5 weeks + gap */
        repeat(4, 1fr) 6px  /* Oct: 4 weeks + gap */
        repeat(4, 1fr) 6px  /* Nov: 4 weeks + gap */
        repeat(5, 1fr);     /* Dec: 5 weeks (no gap at end) */
      grid-template-rows: 
        repeat(10, 1fr) 10px  /* Decade 1: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 2: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 3: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 4: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 5: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 6: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 7: 10 years + gap */
        repeat(10, 1fr) 10px  /* Decade 8: 10 years + gap */
        repeat(10, 1fr);      /* Decade 9: 10 years (no gap at end) */
      gap: 1px;
      max-width: 100%;
      position: relative;
      padding: 1px;
    }
    .week { 
      position: relative; 
      background-color: #f8f9fa; 
    }
    .week::before { 
      content: ""; 
      display: block; 
      padding-top: 100%; 
    }
    /* --- Age Tooltip Styles --- */
    .age-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 10000;
      pointer-events: none;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 280px;
      white-space: nowrap;
    }
    .age-tooltip.show {
      opacity: 1;
      transform: translateY(0);
    }
    .age-tooltip .age-main {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #4cc9f0;
    }
    .age-tooltip .age-details {
      font-size: 12px;
      color: #ccc;
      line-height: 1.4;
    }
    .age-tooltip .age-date {
      color: #fff;
      font-weight: 500;
      display: none;
    }
    .age-tooltip .event-info {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    .age-tooltip .event-title {
      color: #4cc9f0;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .age-tooltip .event-dates {
      font-size: 11px;
      color: #aaa;
    }
    .age-tooltip .arrow {
      position: absolute;
      width: 0;
      height: 0;
      border: 6px solid transparent;
    }
    .age-tooltip .arrow.top {
      bottom: -6px;
      border-top-color: rgba(0, 0, 0, 0.9);
    }
    .age-tooltip .arrow.bottom {
      top: -6px;
      border-bottom-color: rgba(0, 0, 0, 0.9);
    }
    .age-tooltip .arrow.left {
      right: -6px;
      border-left-color: rgba(0, 0, 0, 0.9);
    }
    .age-tooltip .arrow.right {
      left: -6px;
      border-right-color: rgba(0, 0, 0, 0.9);
    }

    /* --- Enhanced Week Cell Hover Effects --- */
    .week-inner {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 1px solid #eaeaea;
      background-color: #f8f9fa;
      border-radius: 3px;
      transition: background 0.3s, transform 0.1s ease, box-shadow 0.1s ease;
      cursor: pointer;
    }
    .week-inner:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 10;
    }
    .week.lived .week-inner { 
      background-color: #4cc9f0; 
    }
    .week.lived .week-inner:hover {
      background-color: #3bb8d9 !important;
    }
    .week:not(.lived) .week-inner:hover {
      background-color: #e9ecef !important;
    }
    /* Removed thick borders - now using CSS grid gaps for spacing */
    /* Removed old boundary styling - now using CSS Grid gaps for clean separation */
    /* Removed old gap styling - now using CSS Grid gaps */
    .event-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0.8;
      cursor: pointer;
      transition: opacity 0.2s;
      border-radius: 3px;
      z-index: 2; /* Ensure overlays appear above gap borders */
    }
    .event-overlay:hover { 
      opacity: 1; 
    }
    .skull-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #900;
      pointer-events: none;
      z-index: 3; /* Ensure skull appears above event overlays and gap borders */
    }
    
    /* --- App Buttons --- */
    .button-group {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    #printButton, #galleryButton {
      padding: 10px 16px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #printButton::before {
      content: "📷";
    }
    #galleryButton::before {
      content: "🖼️";
    }
    
    /* --- Draggable Event Form --- */
    #eventForm {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 320px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
      overflow: hidden;
    }
    #eventFormHeader {
      background: #f8f9fa;
      padding: 12px 16px;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eaeaea;
    }
    #eventFormHeader span { 
      font-weight: 600; 
      color: #333;
    }
    #eventFormHeader button {
      background: none;
      color: #666;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin-left: 5px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    #eventFormHeader button:hover {
      background-color: rgba(0,0,0,0.05);
      color: #333;
    }
    #eventFormContent { 
      padding: 16px; 
    }
    #eventFormContent label {
      font-weight: 500;
      margin-top: 12px;
      display: block;
      color: #555;
      font-size: 14px;
    }
    #eventFormContent input {
      width: 100%;
      padding: 10px 12px;
      margin: 6px 0 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    #eventFormContent input:focus {
      outline: none;
      border-color: #4361ee;
    }
    #eventFormContent button { 
      width: 100%;
      margin-top: 16px;
    }
    
    /* --- Show Event Form Button --- */
    #showEventFormButton {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
      padding: 12px;
      border-radius: 50%;
      background: #4361ee;
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      font-size: 18px;
      width: 50px;
      height: 50px;
      display: none;
      align-items: center;
      justify-content: center;
    }
    #showEventFormButton::after {
      content: "+";
      font-weight: bold;
      font-size: 24px;
    }
    
    /* --- Floating Draggable Legend --- */
    #legend {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 12px;
      max-width: 240px;
      z-index: 1000;
      display: none;
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    /* Legend header for dragging */
    #legendHeader {
      background: #f8f9fa;
      padding: 12px 16px;
      cursor: move;
      border-bottom: 1px solid #eaeaea;
    }
    #legendHeader h3 { 
      font-size: 14px; 
      margin: 0; 
      color: #333;
    }
    #legendContent { 
      padding: 12px 16px; 
    }
    .legend-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      margin-bottom: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-radius: 4px;
    }
    .legend-item:hover {
      background-color: #f5f7ff;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      margin-right: 12px;
      border-radius: 3px;
    }
    
    /* --- Gallery Modal --- */
    #galleryModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      z-index: 2000;
    }
    #galleryContent {
      background: white;
      width: 90%;
      max-width: 800px;
      margin: 50px auto;
      padding: 24px;
      position: relative;
      border-radius: 12px;
      max-height: 80%;
      overflow-y: auto;
    }
    #galleryContent h2 {
      margin-top: 0;
      color: #333;
    }
    #galleryItems {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 1.5rem;
    }
    .gallery-item {
      border: 1px solid #eaeaea;
      padding: 16px;
      border-radius: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .gallery-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .gallery-item img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .gallery-item p {
      font-size: 14px;
      color: #555;
      margin-bottom: 10px;
    }
    .gallery-item-buttons {
      display: flex;
      gap: 8px;
    }
    .gallery-item button {
      flex: 1;
      padding: 8px;
      font-size: 13px;
    }
    #closeGalleryButton {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      color: #333;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      padding: 0;
    }
    #closeGalleryButton:hover {
      background-color: rgba(0,0,0,0.05);
    }
    
    /* --- Hidden Print Area --- */
    #printArea {
      position: absolute;
      top: -10000px;
      left: -10000px;
      background: white;
      padding: 30px;
      border-radius: 12px;
    }
    
    /* --- Responsive Adjustments --- */
    @media (max-width: 768px) {
      .grid-controls {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
      }
      #presetMenu {
        width: 100%;
      }
      #presetSelect {
        flex-grow: 1;
      }
      .button-group {
        flex-direction: column;
      }
      #eventForm {
        width: 90%;
        max-width: 320px;
      }
    }
    
    /* --- Font Import --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  </style>
  <!-- Include html2canvas library from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- Introduction Section - New! -->
    <div class="intro-section" id="introSection">
      <h1>Your Life in Weeks</h1>
      <p>Each week of your life is represented by a <span class="intro-highlight">single square</span> on the grid. The average human lives about 4,680 weeks (90 years).</p>
      <div class="intro-visual"></div>
      <p>This visualization helps you understand the limited time we have and make the most of it. Add important life events and see your journey unfold.</p>
      <button id="startButton">Get Started</button>
    </div>
    
    <!-- Authentication UI -->
    <div id="authContainer" style="display: none;">
      <h1 id="authTitle">Login</h1>
      <input type="email" id="authEmail" placeholder="Email" autofocus />
      <input type="password" id="authPassword" placeholder="Password" />
      <!-- First Name and Birth Date fields shown only in Register mode -->
      <input type="text" id="authFirstName" placeholder="First Name" style="display:none;" />
      <input type="date" id="authBirthdate" placeholder="Birth Date" style="display:none;" />
      <button id="authButton">Login</button>
      <div class="toggle-link" id="toggleAuthMode">No account? Register here</div>
    </div>
    
    <!-- Main Life Tracker UI -->
    <div id="gridContainer">
      <h2>Your Life in Weeks</h2>
      
      <!-- Grid Controls -->
      <div class="grid-controls">
        <!-- Preset Menu -->
        <div id="presetMenu">
          <select id="presetSelect">
            <option value="my">My Life Chart</option>
          </select>
          <button id="loadPresetButton">Load Chart</button>
        </div>
        
        <!-- Log Out Button -->
        <button id="logoutButton">Log Out</button>
      </div>
      
      <div id="gridArea">
        <div id="corner"></div>
        <div id="xAxis"></div>
        <div id="yAxis"></div>
        <div id="grid">
          <div id="lifeGrid"></div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="button-group">
        <button id="printButton">Save as Image</button>
        <button id="galleryButton">View Gallery</button>
      </div>
    </div>
  </div>

  <!-- Draggable Event Form -->
  <div id="eventForm">
    <div id="eventFormHeader">
      <span>Add Life Event</span>
      <div>
        <button id="minimizeEventFormButton" title="Minimize">–</button>
        <button id="closeEventFormButton" title="Close">×</button>
      </div>
    </div>
    <div id="eventFormContent">
      <label for="eventTitle">Title:</label>
      <input type="text" id="eventTitle" placeholder="Event title" />
      <label for="eventColor">Color:</label>
      <input type="color" id="eventColor" value="#4361ee" />
      <label for="eventStart">Start Date:</label>
      <input type="date" id="eventStart" />
      <label for="eventEnd">End Date:</label>
      <input type="date" id="eventEnd" />
      <button id="addEventButton">Add Event</button>
    </div>
  </div>

  <!-- Button to show Event Form if hidden -->
  <button id="showEventFormButton"></button>

  <!-- Floating Draggable Legend -->
  <div id="legend">
    <div id="legendHeader">
      <h3>Event Legend</h3>
    </div>
    <div id="legendContent">
      <div id="legendItems"></div>
    </div>
  </div>

  <!-- Hidden Print Area (used to generate a snapshot for printing) -->
  <div id="printArea"></div>

  <!-- Gallery Modal -->
  <div id="galleryModal">
    <div id="galleryContent">
      <button id="closeGalleryButton">×</button>
      <h2>Life Grid Gallery</h2>
      <div id="galleryItems"></div>
    </div>
  </div>

  <!-- Age Tooltip -->
  <div id="ageTooltip" class="age-tooltip">
    <div class="age-main"></div>
    <div class="age-details">
      <div class="age-date"></div>
    </div>
    <div class="event-info" style="display: none;">
      <div class="event-title"></div>
      <div class="event-dates"></div>
    </div>
    <div class="arrow"></div>
  </div>

  <script>
    /********* Global Variables & Settings *********/
    const maxYears = 90;
    const weeksPerYear = 52;
    const totalWeeks = maxYears * weeksPerYear;
    const msPerWeek = 1000 * 60 * 60 * 24 * 7;
    const baseUrl = ""; // Assumes same domain/port as your Node server

    // For "My Life Chart"
    let token = localStorage.getItem("token") || null;
    let userBirthDate = localStorage.getItem("birthDate") || null;
    const lifeEvents = []; // Personal events

    // Global mode flag to distinguish between personal and preset mode.
    let isPresetMode = false;
    // Global variable for celebrity presets
    let celebPresets = [];
    
    // Global variable to store birth week for event mapping
    let birthWeekInYear = 0;

    /********* Helper function to convert life weeks to grid indices *********/
    function lifeWeekToGridIndex(lifeWeek, birthWeekInYear) {
      return birthWeekInYear + lifeWeek; // Simple addition
    }

    /********* Helper function to calculate week position based on month structure *********/
    function getWeekPositionFromDate(date) {
      // Calculate the actual week of the year (0-51) for standard calendar
      const startOfYear = new Date(date.getFullYear(), 0, 1);
      const dayOfYear = Math.floor((date - startOfYear) / (1000 * 60 * 60 * 24)) + 1;
      
      // Find which day of the week January 1st falls on (0 = Sunday, 1 = Monday, etc.)
      const startDayOfWeek = startOfYear.getDay();
      
      // Calculate week number (0-51)
      // We need to adjust for the fact that the first week might be partial
      const weekNumber = Math.floor((dayOfYear - 1 + startDayOfWeek) / 7);
      
      // Cap at 51 since we have 52 weeks (0-51)
      const result = Math.min(weekNumber, 51);
      
      // DEBUG: Log calculation details
      console.log(`Week calculation for ${date.toDateString()}:`);
      console.log(`  Day of year: ${dayOfYear}`);
      console.log(`  Start day of week (Jan 1): ${startDayOfWeek}`);
      console.log(`  Calculated week: ${weekNumber}`);
      console.log(`  Final result: ${result}`);
      
      return result;
    }

    // Define a set of contrasting colors for preset events.
    const presetColors = ["#4361ee", "#3a0ca3", "#7209b7", "#f72585", "#4cc9f0", "#4895ef", "#560bad", "#b5179e", "#f15bb5", "#fee440"];
    const contrastThreshold = 100; // Minimum Euclidean distance between RGB values

    /********* Helper Functions for Color Contrast *********/
    function hexToRgb(hex) {
      hex = hex.replace(/^#/, '');
      if (hex.length === 3) {
        hex = hex.split('').map(c => c + c).join('');
      }
      const num = parseInt(hex, 16);
      return {
        r: (num >> 16) & 255,
        g: (num >> 8) & 255,
        b: num & 255
      };
    }
    function colorDistance(hex1, hex2) {
      const c1 = hexToRgb(hex1);
      const c2 = hexToRgb(hex2);
      return Math.sqrt(
        Math.pow(c1.r - c2.r, 2) +
        Math.pow(c1.g - c2.g, 2) +
        Math.pow(c1.b - c2.b, 2)
      );
    }
    function getContrastingColor(prevColor) {
      for (let i = 0; i < presetColors.length; i++) {
        if (colorDistance(prevColor, presetColors[i]) >= contrastThreshold) {
          return presetColors[i];
        }
      }
      return presetColors[0];
    }

    /********* Age Calculation and Tooltip Functions *********/
    function calculateAgeFromGridIndex(gridIndex, birthWeekInYear, birthDate) {
      // Convert grid index back to life week
      const lifeWeek = gridIndex - birthWeekInYear;
      
      if (lifeWeek < 0) {
        return {
          age: null,
          date: null,
          message: "Before birth"
        };
      }
      
      // Calculate the date for this week
      const weekDate = new Date(birthDate);
      weekDate.setDate(weekDate.getDate() + (lifeWeek * 7));
      
      // Calculate age in years
      const ageInMs = weekDate - birthDate;
      const ageInWeeks = Math.floor(ageInMs / msPerWeek);
      const ageInYears = Math.floor(ageInWeeks / 52);
      
      return {
        age: {
          years: ageInYears
        },
        date: weekDate,
        lifeWeek: lifeWeek
      };
    }

    function formatAge(age) {
      if (!age) return "Before birth";
      
      const { years } = age;
      if (years === 0) {
        return "Less than 1 year";
      }
      return `${years} year${years !== 1 ? 's' : ''}`;
    }

    function findEventForWeek(lifeWeek) {
      if (isPresetMode) {
        // For preset mode, we need to check preset events
        const selectedPreset = celebPresets.find(p => p.name === presetSelect.value);
        if (selectedPreset) {
          return selectedPreset.lifeEvents.find(ev => {
            const presetDob = new Date(selectedPreset.dob);
            const evStart = new Date(ev.startDate);
            const evEnd = ev.endDate ? new Date(ev.endDate) : new Date();
            const startWeek = Math.floor((evStart - presetDob) / msPerWeek);
            const endWeek = Math.ceil((evEnd - presetDob) / msPerWeek);
            return lifeWeek >= startWeek && lifeWeek < endWeek;
          });
        }
      } else {
        // For personal mode, check user events
        return lifeEvents.find(ev => lifeWeek >= ev.startWeek && lifeWeek < ev.endWeek);
      }
      return null;
    }

    function showAgeTooltip(event, cell) {
      const gridIndex = parseInt(cell.dataset.weekIndex);
      const birthDate = isPresetMode ? 
        new Date(celebPresets.find(p => p.name === presetSelect.value)?.dob) : 
        new Date(localStorage.getItem("birthDate"));
      
      const ageInfo = calculateAgeFromGridIndex(gridIndex, birthWeekInYear, birthDate);
      
      if (!ageInfo.age) {
        // Before birth
        ageTooltipMain.textContent = "Before birth";
        ageTooltipDate.style.display = "none";
        ageTooltipEventInfo.style.display = "none";
      } else {
        // After birth
        ageTooltipMain.textContent = formatAge(ageInfo.age);
        ageTooltipDate.style.display = "none";
        
        // Check for events
        const event = findEventForWeek(ageInfo.lifeWeek);
        if (event) {
          ageTooltipEventInfo.style.display = "block";
          ageTooltipEventTitle.textContent = event.title;
          const startDate = new Date(event.startDate).toLocaleDateString();
          const endDate = event.endDate ? new Date(event.endDate).toLocaleDateString() : "Present";
          ageTooltipEventDates.textContent = `${startDate} - ${endDate}`;
        } else {
          ageTooltipEventInfo.style.display = "none";
        }
      }
      
      // Position tooltip relative to mouse cursor
      const tooltipRect = ageTooltip.getBoundingClientRect();
      
      // Get scroll position
      const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
      const scrollY = window.pageYOffset || document.documentElement.scrollTop;
      
      // Calculate position relative to mouse cursor, accounting for scroll
      let left = event.clientX + scrollX - (tooltipRect.width / 2);
      let top = event.clientY + scrollY - tooltipRect.height - 15;
      
      // Adjust if tooltip goes off screen
      if (top < scrollY + 10) {
        top = event.clientY + scrollY + 15;
        ageTooltipArrow.className = "arrow top";
      } else {
        ageTooltipArrow.className = "arrow bottom";
      }
      
      if (left < scrollX + 10) {
        left = scrollX + 10;
      } else if (left + tooltipRect.width > scrollX + window.innerWidth - 10) {
        left = scrollX + window.innerWidth - tooltipRect.width - 10;
      }
      
      ageTooltip.style.left = left + "px";
      ageTooltip.style.top = top + "px";
      ageTooltip.classList.add("show");
    }

    function updateTooltipPosition(event) {
      if (ageTooltip.classList.contains("show")) {
        const tooltipRect = ageTooltip.getBoundingClientRect();
        
        // Get scroll position
        const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
        const scrollY = window.pageYOffset || document.documentElement.scrollTop;
        
        // Calculate position relative to mouse cursor, accounting for scroll
        let left = event.clientX + scrollX - (tooltipRect.width / 2);
        let top = event.clientY + scrollY - tooltipRect.height - 15;
        
        // Adjust if tooltip goes off screen
        if (top < scrollY + 10) {
          top = event.clientY + scrollY + 15;
          ageTooltipArrow.className = "arrow top";
        } else {
          ageTooltipArrow.className = "arrow bottom";
        }
        
        if (left < scrollX + 10) {
          left = scrollX + 10;
        } else if (left + tooltipRect.width > scrollX + window.innerWidth - 10) {
          left = scrollX + window.innerWidth - tooltipRect.width - 10;
        }
        
        ageTooltip.style.left = left + "px";
        ageTooltip.style.top = top + "px";
      }
    }

    function hideAgeTooltip() {
      ageTooltip.classList.remove("show");
    }

    /********* Load Celebrity Presets from JSON *********/
    fetch('celebPresets.json')
      .then(response => response.json())
      .then(data => {
        celebPresets = data;
        populatePresetMenu();
      })
      .catch(err => console.error("Error loading celebrity presets:", err));

    /********* DOM ELEMENTS *********/
    const introSection = document.getElementById("introSection");
    const startButton = document.getElementById("startButton");
    
    const authContainer = document.getElementById("authContainer");
    const authTitle = document.getElementById("authTitle");
    const authEmail = document.getElementById("authEmail");
    const authPassword = document.getElementById("authPassword");
    const authBirthdate = document.getElementById("authBirthdate");
    const authFirstName = document.getElementById("authFirstName");
    const authButton = document.getElementById("authButton");
    const toggleAuthMode = document.getElementById("toggleAuthMode");

    const gridContainer = document.getElementById("gridContainer");
    const logoutButton = document.getElementById("logoutButton");
    const presetSelect = document.getElementById("presetSelect");
    const loadPresetButton = document.getElementById("loadPresetButton");
    const xAxis = document.getElementById("xAxis");
    const yAxis = document.getElementById("yAxis");
    const lifeGrid = document.getElementById("lifeGrid");

    const eventForm = document.getElementById("eventForm");
    const eventFormHeader = document.getElementById("eventFormHeader");
    const eventFormContent = document.getElementById("eventFormContent");
    const addEventButton = document.getElementById("addEventButton");
    const eventTitleInput = document.getElementById("eventTitle");
    const eventColorInput = document.getElementById("eventColor");
    const eventStartInput = document.getElementById("eventStart");
    const eventEndInput = document.getElementById("eventEnd");

    const minimizeEventFormButton = document.getElementById("minimizeEventFormButton");
    const closeEventFormButton = document.getElementById("closeEventFormButton");
    const showEventFormButton = document.getElementById("showEventFormButton");

    const legend = document.getElementById("legend");
    const legendHeader = document.getElementById("legendHeader");
    const legendItems = document.getElementById("legendItems");

    const printButton = document.getElementById("printButton");
    const galleryButton = document.getElementById("galleryButton");
    const printArea = document.getElementById("printArea");

    const galleryModal = document.getElementById("galleryModal");
    const closeGalleryButton = document.getElementById("closeGalleryButton");
    const galleryItems = document.getElementById("galleryItems");

    const ageTooltip = document.getElementById("ageTooltip");
    const ageTooltipMain = ageTooltip.querySelector(".age-main");
    const ageTooltipDate = ageTooltip.querySelector(".age-date");
    const ageTooltipEventInfo = ageTooltip.querySelector(".event-info");
    const ageTooltipEventTitle = ageTooltip.querySelector(".event-title");
    const ageTooltipEventDates = ageTooltip.querySelector(".event-dates");
    const ageTooltipArrow = ageTooltip.querySelector(".arrow");

    const monthWeekCounts = [4,4,5,4,4,5,4,4,5,4,4,5];
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    /********* Intro Section Start Button *********/
    startButton.addEventListener("click", () => {
      introSection.style.display = "none";
      authContainer.style.display = "block";
    });

    /********* Authentication Mode Toggle *********/
    let isRegisterMode = false;
    toggleAuthMode.addEventListener("click", () => {
      isRegisterMode = !isRegisterMode;
      if(isRegisterMode) {
        authTitle.textContent = "Register";
        authButton.textContent = "Register";
        toggleAuthMode.textContent = "Have an account? Login here";
        authBirthdate.style.display = "block";
        authFirstName.style.display = "block";
      } else {
        authTitle.textContent = "Login";
        authButton.textContent = "Login";
        toggleAuthMode.textContent = "No account? Register here";
        authBirthdate.style.display = "none";
        authFirstName.style.display = "none";
      }
    });

    /********* Authentication Handler *********/
    authButton.addEventListener("click", async () => {
      const email = authEmail.value.trim();
      const password = authPassword.value.trim();
      if(!email || !password) {
        alert("Please fill in email and password.");
        return;
      }
      let endpoint = isRegisterMode ? "/api/register" : "/api/login";
      let payload = { email, password };
      if(isRegisterMode) {
        const bd = authBirthdate.value;
        const firstName = authFirstName.value.trim();
        if(!firstName) {
          alert("Please enter your first name.");
          return;
        }
        if(!bd) {
          alert("Please enter your birth date for registration.");
          return;
        }
        localStorage.setItem("firstName", firstName);
        payload.birthDate = bd;
      }
      try {
        const response = await fetch(baseUrl + endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        if(!response.ok) {
          alert(data.error || "Authentication error");
          return;
        }
        token = data.token;
        localStorage.setItem("token", token);
        const myBD = data.birthDate || authBirthdate.value;
        localStorage.setItem("birthDate", myBD);
        authContainer.style.display = "none";
        gridContainer.style.display = "block";
        eventForm.style.display = "block";
        isPresetMode = false;
        initializeMainApp();
      } catch (err) {
        console.error(err);
        alert("Error communicating with server.");
      }
    });

    /********* Log Out Handler *********/
    logoutButton.addEventListener("click", () => {
      localStorage.removeItem("token");
      localStorage.removeItem("birthDate");
      localStorage.removeItem("firstName");
      token = null;
      userBirthDate = null;
      lifeEvents.length = 0;
      gridContainer.style.display = "none";
      eventForm.style.display = "none";
      introSection.style.display = "block";
    });

    /********* On Page Load, Check for Existing Token *********/
    window.addEventListener("load", () => {
      if(token && localStorage.getItem("birthDate")) {
        userBirthDate = localStorage.getItem("birthDate");
        introSection.style.display = "none";
        authContainer.style.display = "none";
        gridContainer.style.display = "block";
        eventForm.style.display = "block";
        initializeMainApp();
      } else {
        introSection.style.display = "block";
        authContainer.style.display = "none";
        gridContainer.style.display = "none";
      }
    });

    /********* Populate Preset Menu *********/
    function populatePresetMenu() {
      celebPresets.forEach(celeb => {
        const opt = document.createElement("option");
        opt.value = celeb.name;
        opt.textContent = celeb.name;
        presetSelect.appendChild(opt);
      });
    }

    /********* Preset Menu Handler *********/
    loadPresetButton.addEventListener("click", () => {
      const selected = presetSelect.value;
      if(selected === "my") {
        isPresetMode = false;
        initializeMainApp();
      } else {
        const preset = celebPresets.find(c => c.name === selected);
        if(preset) {
          isPresetMode = true;
          clearPersonalEvents();
          renderPresetChart(preset);
        }
      }
    });

    function clearPersonalEvents() {
      lifeEvents.length = 0;
      updateLegend();
    }

    /********* Initialize "My Life Chart" *********/
    async function initializeMainApp() {
      const now = new Date();
      const birthDateObj = new Date(localStorage.getItem("birthDate"));
      
      // Calculate actual weeks lived (the accurate measurement)
      let exactWeeksLived = (now - birthDateObj) / msPerWeek;
      if(exactWeeksLived > totalWeeks) exactWeeksLived = totalWeeks;
      const fullWeeks = Math.floor(exactWeeksLived);
      const partialWeekFraction = exactWeeksLived - fullWeeks;
      
      // Get the correct birth week for display
      const originalBirthWeek = getWeekPositionFromDate(birthDateObj);
      const currentWeekInYear = getWeekPositionFromDate(now);
      
      // Calculate how to align current date with correct calendar week
      const currentLifeYear = Math.floor(fullWeeks / 52);
      const weekInCurrentLifeYear = fullWeeks % 52;
      const adjustedBirthWeek = (currentWeekInYear - weekInCurrentLifeYear + 52) % 52;
      
      birthWeekInYear = originalBirthWeek; // Store the real birth week for cleanup
      
      // DEBUG: Log values to understand the calculation
      console.log("=== DEBUGGING LIFE GRID (WORKAROUND) ===");
      console.log("Current date:", now.toDateString());
      console.log("Birth date:", birthDateObj.toDateString());
      console.log("Exact weeks lived:", exactWeeksLived);
      console.log("Full weeks lived:", fullWeeks);
      console.log("Real birth week:", originalBirthWeek);
      console.log("Adjusted birth week for alignment:", adjustedBirthWeek);
      console.log("Current calendar week:", currentWeekInYear);
      
      const finalPosition = adjustedBirthWeek + fullWeeks;
      const finalYear = Math.floor(finalPosition / 52);
      const finalWeek = finalPosition % 52;
      console.log(`Final position: Year ${finalYear}, Week ${finalWeek}`);
      console.log("=========================");
      
      const birthYear = birthDateObj.getFullYear();
      generateAxisLabels(birthYear);
      generateGrid(fullWeeks, partialWeekFraction, adjustedBirthWeek, originalBirthWeek);
      await loadUserEvents();
      updateLegend();
    }

    /********* Render Preset Chart *********/
    function renderPresetChart(preset) {
      const currentDate = preset.deathDate ? new Date(preset.deathDate) : new Date();
      const birthDateObj = new Date(preset.dob);
      
      // Calculate total weeks lived from birth to current/death date
      let weeksLived = (currentDate - birthDateObj) / msPerWeek;
      if(weeksLived > totalWeeks) weeksLived = totalWeeks;
      const fullWeeks = Math.floor(weeksLived);
      const partialWeekFraction = weeksLived - fullWeeks;
      
      // Calculate which week of the year the person was born using the grid's month structure
      const birthYear = birthDateObj.getFullYear();
      birthWeekInYear = getWeekPositionFromDate(birthDateObj);
      
      generateAxisLabels(birthYear);
      generateGrid(fullWeeks, partialWeekFraction, birthWeekInYear);
      
      const sortedEvents = preset.lifeEvents.slice().sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
      let prevEventColor = null;
      let prevEventEndWeek = null;
      sortedEvents.forEach((ev, i) => {
        const presetDob = new Date(preset.dob);
        const evStart = new Date(ev.startDate);
        let evEnd;
        if(!ev.endDate || ev.endDate === "") {
          evEnd = currentDate;
        } else {
          evEnd = new Date(ev.endDate);
        }
        const startWeek = Math.floor((evStart - presetDob) / msPerWeek);
        const endWeek = (evStart.getTime() === evEnd.getTime())
                        ? startWeek + 1
                        : Math.ceil((evEnd - presetDob) / msPerWeek);
        let color;
        if (prevEventColor !== null && startWeek === prevEventEndWeek) {
          color = getContrastingColor(prevEventColor);
        } else {
          color = presetColors[i % presetColors.length];
        }
        prevEventColor = color;
        prevEventEndWeek = endWeek;
        const presetEvent = {
          title: ev.title,
          color,
          startWeek,
          endWeek,
          startDate: ev.startDate,
          endDate: ev.endDate
        };
        overlayPresetEvent(presetEvent);
        ev.color = color;
      });
      if (preset.deathDate) {
        const deathDateObj = new Date(preset.deathDate);
        const deathLifeWeek = Math.floor((deathDateObj - birthDateObj) / msPerWeek);
        if (deathLifeWeek >= 0 && deathLifeWeek < totalWeeks) {
          overlaySkull(deathLifeWeek);
        }
      }
      updatePresetLegend(sortedEvents);
      alert("Loaded preset: " + preset.name + ". Your own chart remains saved as 'My Life Chart'.");
    }

    function overlayPresetEvent(ev) {
      const start = ev.startWeek;
      const end = ev.endWeek;
      for (let lifeWeek = start; lifeWeek < end; lifeWeek++) {
        const gridIndex = lifeWeekToGridIndex(lifeWeek, birthWeekInYear);
        if (gridIndex >= 0 && gridIndex < totalWeeks) {
          const cell = lifeGrid.querySelector(`.week[data-week-index='${gridIndex}']`);
          if(cell){
            const inner = cell.querySelector(".week-inner");
            const overlay = document.createElement("div");
            overlay.className = "event-overlay";
            overlay.style.backgroundColor = ev.color;
            overlay.title = `${ev.title}\nFrom: ${new Date(ev.startDate).toLocaleDateString()} To: ${new Date(ev.endDate).toLocaleDateString()}`;
            
            // Add hover events to preset event overlay for tooltip
            overlay.addEventListener("mouseenter", function(e) {
              showAgeTooltip(e, cell);
            });
            
            overlay.addEventListener("mousemove", function(e) {
              updateTooltipPosition(e);
            });
            
            overlay.addEventListener("mouseleave", function(e) {
              hideAgeTooltip();
            });
            
            inner.appendChild(overlay);
          }
        }
      }
    }

    function overlaySkull(lifeWeekIndex) {
      const gridIndex = lifeWeekToGridIndex(lifeWeekIndex, birthWeekInYear);
      const cell = lifeGrid.querySelector(`.week[data-week-index='${gridIndex}']`);
      if(cell){
        const inner = cell.querySelector(".week-inner");
        const skullDiv = document.createElement("div");
        skullDiv.className = "skull-overlay";
        skullDiv.innerHTML = "&#9760;";
        inner.appendChild(skullDiv);
      }
    }

    /********* Update Preset Legend *********/
    function updatePresetLegend(sortedEvents) {
      legendItems.innerHTML = "";
      if(!sortedEvents || sortedEvents.length === 0) {
        legend.style.display = "none";
        return;
      }
      legend.style.display = "block";
      sortedEvents.forEach((ev) => {
        const itemDiv = document.createElement("div");
        itemDiv.className = "legend-item";
        itemDiv.addEventListener("click", function(){
          alert("Preset events cannot be deleted.");
        });
        const colorDiv = document.createElement("div");
        colorDiv.className = "legend-color";
        colorDiv.style.backgroundColor = ev.color;
        const labelSpan = document.createElement("span");
        labelSpan.textContent = ev.title;
        itemDiv.appendChild(colorDiv);
        itemDiv.appendChild(labelSpan);
        legendItems.appendChild(itemDiv);
      });
    }

    /********* Axis & Grid Functions *********/
    function generateAxisLabels(birthYear = 0) {
      xAxis.innerHTML = "";
      yAxis.innerHTML = "";
      let colStart = 0;
      monthWeekCounts.forEach((weeksInMonth, index) => {
        const labelDiv = document.createElement("div");
        labelDiv.className = "month-label";
        labelDiv.textContent = monthNames[index];
        labelDiv.style.gridColumn = `${colStart + 1} / span ${weeksInMonth}`;
        colStart += weeksInMonth;
        xAxis.appendChild(labelDiv);
      });
      for (let decade = 0; decade < 9; decade++) {
        const labelDiv = document.createElement("div");
        labelDiv.className = "decade-label";
        labelDiv.textContent = `${birthYear + decade * 10}–${birthYear + decade * 10 + 9}`;
        labelDiv.style.gridRow = `${decade * 10 + 1} / span 10`;
        yAxis.appendChild(labelDiv);
      }
    }

    /********* Helper Functions for New Grid Structure *********/
    function getGridColumnPosition(weekIndex) {
      // Calculate position in the new grid structure with gaps
      // Each month has its weeks plus a gap, except December
      const monthWeeks = [4,4,5,4,4,5,4,4,5,4,4,5]; // weeks per month
      let position = 1;
      let remainingWeeks = weekIndex;
      
      for (let month = 0; month < 12; month++) {
        if (remainingWeeks < monthWeeks[month]) {
          return position + remainingWeeks;
        }
        position += monthWeeks[month];
        remainingWeeks -= monthWeeks[month];
        
        // Add gap position (except after December)
        if (month < 11) {
          position += 1; // gap column
        }
      }
      
      return position;
    }
    
    function getGridRowPosition(yearIndex) {
      // Calculate position in the new grid structure with decade gaps
      const decade = Math.floor(yearIndex / 10);
      const yearInDecade = yearIndex % 10;
      
      // Each decade has 10 years plus a gap, except the last decade
      return decade * 11 + yearInDecade + 1; // +1 for 1-based grid positioning
    }
    
    function getMonthLabelPosition(monthIndex) {
      // Calculate correct position for month labels in new grid
      const monthWeeks = [4,4,5,4,4,5,4,4,5,4,4,5];
      let position = 1;
      
      for (let i = 0; i < monthIndex; i++) {
        position += monthWeeks[i] + 1; // +1 for gap
      }
      
      return position;
    }
    
    function getDecadeLabelPosition(decadeIndex) {
      // Calculate correct position for decade labels in new grid
      return decadeIndex * 11 + 1; // 10 years + 1 gap per decade, +1 for 1-based positioning
    }

    /********* Updated Axis & Grid Functions *********/
    function generateAxisLabels(birthYear = 0) {
      xAxis.innerHTML = "";
      yAxis.innerHTML = "";
      
      // Create month labels with correct positioning for new grid structure
      monthWeekCounts.forEach((weeksInMonth, index) => {
        const labelDiv = document.createElement("div");
        labelDiv.className = "month-label";
        labelDiv.textContent = monthNames[index];
        const startPos = getMonthLabelPosition(index);
        labelDiv.style.gridColumn = `${startPos} / span ${weeksInMonth}`;
        xAxis.appendChild(labelDiv);
      });
      
      // Create decade labels with correct positioning for new grid structure
      for (let decade = 0; decade < 9; decade++) {
        const labelDiv = document.createElement("div");
        labelDiv.className = "decade-label";
        labelDiv.textContent = `${birthYear + decade * 10}–${birthYear + decade * 10 + 9}`;
        const startPos = getDecadeLabelPosition(decade);
        labelDiv.style.gridRow = `${startPos} / span 10`;
        yAxis.appendChild(labelDiv);
      }
    }

    function generateGrid(fullWeeks, partialFraction, adjustedBirthWeek = 0, realBirthWeek = null) {
      lifeGrid.innerHTML = "";
      
      // Create all grid cells first with correct positioning for gaps
      for (let gridIndex = 0; gridIndex < totalWeeks; gridIndex++) {
        const year = Math.floor(gridIndex / weeksPerYear);
        const weekInYear = gridIndex % weeksPerYear;
        const weekDiv = document.createElement("div");
        weekDiv.classList.add("week");
        weekDiv.dataset.weekIndex = gridIndex;
        
        // Calculate correct grid position in new structure with gaps
        const gridColumn = getGridColumnPosition(weekInYear);
        const gridRow = getGridRowPosition(year);
        weekDiv.style.gridColumn = gridColumn;
        weekDiv.style.gridRow = gridRow;
        

        
        const innerDiv = document.createElement("div");
        innerDiv.classList.add("week-inner");
        
        // Add hover event listeners for age tooltip
        innerDiv.addEventListener("mouseenter", function(e) {
          showAgeTooltip(e, weekDiv);
        });
        
        innerDiv.addEventListener("mousemove", function(e) {
          updateTooltipPosition(e);
        });
        
        innerDiv.addEventListener("mouseleave", function(e) {
          hideAgeTooltip();
        });
        
        weekDiv.appendChild(innerDiv);
        lifeGrid.appendChild(weekDiv);
      }
      
      // Now shade the cells that represent weeks lived
      // Start from the adjusted birth week position and shade chronologically
      let currentGridIndex = adjustedBirthWeek; // Start at adjusted birth week in first year
      
      console.log("=== GRID SHADING DEBUG (WITH CLEANUP) ===");
      console.log("Starting to shade from adjusted birth week:", adjustedBirthWeek);
      console.log("Real birth week:", realBirthWeek);
      console.log("Will shade", fullWeeks, "complete weeks");
      
      // Shade complete weeks lived
      for (let lifeWeek = 0; lifeWeek < fullWeeks; lifeWeek++) {
        if (currentGridIndex < totalWeeks) {
          const weekCell = lifeGrid.querySelector(`.week[data-week-index='${currentGridIndex}']`);
          if (weekCell) {
            weekCell.classList.add("lived");
          }
        }
        currentGridIndex++;
      }
      
      // Handle partial week
      if (partialFraction > 0 && currentGridIndex < totalWeeks) {
        const weekCell = lifeGrid.querySelector(`.week[data-week-index='${currentGridIndex}']`);
        if (weekCell) {
          const innerDiv = weekCell.querySelector(".week-inner");
          const percent = partialFraction * 100;
          innerDiv.style.background = `linear-gradient(to right, #4cc9f0 ${percent}%, #f8f9fa ${percent}%)`;
        }
      }
      
      // CLEANUP: Remove shading from cells that appear before the real birth week
      if (realBirthWeek !== null && adjustedBirthWeek !== realBirthWeek) {
        console.log("Cleaning up shading before real birth week...");
        
        // Calculate how many cells to clean up in the first year
        if (adjustedBirthWeek < realBirthWeek) {
          // Clean up cells from adjustedBirthWeek to realBirthWeek-1
          for (let weekIndex = adjustedBirthWeek; weekIndex < realBirthWeek; weekIndex++) {
            const weekCell = lifeGrid.querySelector(`.week[data-week-index='${weekIndex}']`);
            if (weekCell) {
              weekCell.classList.remove("lived");
              const innerDiv = weekCell.querySelector(".week-inner");
              innerDiv.style.background = ""; // Remove any gradient
              console.log(`Removed shading from week ${weekIndex} (before birth)`);
            }
          }
        } else {
          // Clean up cells from 0 to adjustedBirthWeek if we wrapped around
          const weeksToClean = adjustedBirthWeek + fullWeeks - realBirthWeek - fullWeeks;
          for (let i = 0; i < weeksToClean; i++) {
            const weekIndex = i;
            const weekCell = lifeGrid.querySelector(`.week[data-week-index='${weekIndex}']`);
            if (weekCell) {
              weekCell.classList.remove("lived");
              const innerDiv = weekCell.querySelector(".week-inner");
              innerDiv.style.background = ""; // Remove any gradient
              console.log(`Removed shading from week ${weekIndex} (before birth)`);
            }
          }
        }
      }
      
      console.log("Final current position grid index:", currentGridIndex);
      console.log("=========================");
      
      if (!isPresetMode) {
        overlayEvents();
      }
    }

    /********* Event Handling for "My Life Chart" *********/
    addEventButton.addEventListener("click", async () => {
      const title = eventTitleInput.value.trim();
      const color = eventColorInput.value;
      const startDateValue = eventStartInput.value;
      const endDateValue = eventEndInput.value;
      if(!title || !startDateValue || !endDateValue){
        alert("Please fill in all fields for the event.");
        return;
      }
      const startDate = new Date(startDateValue);
      const endDate = new Date(endDateValue);
      if(startDate > endDate){
        alert("Start date cannot be after end date.");
        return;
      }
      const eventStartWeek = Math.floor((startDate - new Date(localStorage.getItem("birthDate"))) / msPerWeek);
      const eventEndWeek = Math.ceil((endDate - new Date(localStorage.getItem("birthDate"))) / msPerWeek);
      const payload = {
        title,
        color,
        startDate: startDate.toISOString(),
        endDate: endDate.toISOString(),
        startWeek: eventStartWeek,
        endWeek: eventEndWeek
      };
      try {
        const response = await fetch(baseUrl + "/api/event", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        if(!response.ok){
          alert(data.error || "Error saving event");
          return;
        }
        lifeEvents.push(data.event);
        eventTitleInput.value = "";
        eventStartInput.value = "";
        eventEndInput.value = "";
        overlayEvents();
        updateLegend();
      } catch(err) {
        console.error(err);
        alert("Error communicating with server.");
      }
    });

    async function loadUserEvents() {
      try {
        const response = await fetch(baseUrl + "/api/events", {
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await response.json();
        if(response.ok){
          lifeEvents.length = 0;
          data.events.forEach(ev => lifeEvents.push(ev));
          overlayEvents();
          updateLegend();
        } else {
          alert(data.error || "Error loading events");
        }
      } catch(err) {
        console.error(err);
      }
    }

    function overlayEvents() {
      document.querySelectorAll(".event-overlay").forEach(overlay => overlay.remove());
      lifeEvents.forEach(ev => {
        const start = ev.startWeek;
        const end = ev.endWeek;
        for (let lifeWeek = start; lifeWeek < end; lifeWeek++) {
          const gridIndex = lifeWeekToGridIndex(lifeWeek, birthWeekInYear);
          if (gridIndex >= 0 && gridIndex < totalWeeks) {
            const cell = lifeGrid.querySelector(`.week[data-week-index='${gridIndex}']`);
            if (cell) {
              const inner = cell.querySelector(".week-inner");
              const overlay = document.createElement("div");
              overlay.className = "event-overlay";
              overlay.style.backgroundColor = ev.color;
              overlay.title = `${ev.title}\nFrom: ${new Date(ev.startDate).toLocaleDateString()} To: ${new Date(ev.endDate).toLocaleDateString()}`;
              overlay.addEventListener("click", function(e){
                e.stopPropagation();
                if(confirm(`Delete event "${ev.title}"?`)){
                  deleteEvent(ev._id || ev.id);
                }
              });
              
              // Add hover events to event overlay for tooltip
              overlay.addEventListener("mouseenter", function(e) {
                showAgeTooltip(e, cell);
              });
              
              overlay.addEventListener("mousemove", function(e) {
                updateTooltipPosition(e);
              });
              
              overlay.addEventListener("mouseleave", function(e) {
                hideAgeTooltip();
              });
              
              inner.appendChild(overlay);
            }
          }
        }
      });
    }

    async function deleteEvent(id) {
      try {
        const response = await fetch(baseUrl + "/api/event/" + id, {
          method: "DELETE",
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await response.json();
        if(response.ok){
          const index = lifeEvents.findIndex(ev => (ev._id || ev.id) == id);
          if(index > -1){
            lifeEvents.splice(index, 1);
            overlayEvents();
            updateLegend();
          }
        } else {
          alert(data.error || "Error deleting event");
        }
      } catch(err) {
        console.error(err);
      }
    }

    function updateLegend() {
      legendItems.innerHTML = "";
      if(lifeEvents.length === 0) {
        legend.style.display = "none";
        return;
      }
      legend.style.display = "block";
      lifeEvents.forEach(ev => {
        const itemDiv = document.createElement("div");
        itemDiv.className = "legend-item";
        itemDiv.addEventListener("click", function(){
          if(confirm(`Delete event "${ev.title}"?`)){
            deleteEvent(ev._id || ev.id);
          }
        });
        const colorDiv = document.createElement("div");
        colorDiv.className = "legend-color";
        colorDiv.style.backgroundColor = ev.color;
        const labelSpan = document.createElement("span");
        labelSpan.textContent = ev.title;
        itemDiv.appendChild(colorDiv);
        itemDiv.appendChild(labelSpan);
        legendItems.appendChild(itemDiv);
      });
    }

    /********* Draggable, Minimizable Event Form *********/
    let isDraggingEventForm = false, eventFormOffsetX = 0, eventFormOffsetY = 0;
    eventFormHeader.addEventListener("mousedown", function(e){
      isDraggingEventForm = true;
      const rect = eventForm.getBoundingClientRect();
      eventForm.style.bottom = "auto";
      eventFormOffsetX = e.clientX - rect.left;
      eventFormOffsetY = e.clientY - rect.top;
    });
    document.addEventListener("mousemove", function(e){
      if(isDraggingEventForm){
        eventForm.style.left = (e.clientX - eventFormOffsetX) + "px";
        eventForm.style.top = (e.clientY - eventFormOffsetY) + "px";
      }
    });
    document.addEventListener("mouseup", function(){ isDraggingEventForm = false; });
    let isMinimized = false;
    minimizeEventFormButton.addEventListener("click", function(){
      if(!isMinimized){
        eventFormContent.style.display = "none";
        minimizeEventFormButton.textContent = "+";
        isMinimized = true;
      } else {
        eventFormContent.style.display = "block";
        minimizeEventFormButton.textContent = "–";
        isMinimized = false;
      }
    });
    closeEventFormButton.addEventListener("click", function(){
      eventForm.style.display = "none";
      showEventFormButton.style.display = "flex";
    });
    showEventFormButton.addEventListener("click", function(){
      eventForm.style.display = "block";
      showEventFormButton.style.display = "none";
    });

    /********* Draggable Legend Functionality *********/
    let isDraggingLegend = false, legendOffsetX = 0, legendOffsetY = 0;
    legendHeader.addEventListener("mousedown", function(e) {
      isDraggingLegend = true;
      const rect = legend.getBoundingClientRect();
      legendOffsetX = e.clientX - rect.left;
      legendOffsetY = e.clientY - rect.top;
    });
    document.addEventListener("mousemove", function(e) {
      if(isDraggingLegend) {
        legend.style.left = (e.clientX - legendOffsetX) + "px";
        legend.style.top = (e.clientY - legendOffsetY) + "px";
      }
    });
    document.addEventListener("mouseup", function() {
      isDraggingLegend = false;
    });

    /********* Print and Gallery Functionality *********/
    printButton.addEventListener("click", printLifeGrid);
    galleryButton.addEventListener("click", openGallery);
    closeGalleryButton.addEventListener("click", closeGallery);

    function printLifeGrid() {
      printArea.innerHTML = "";
      
      const printPage = document.createElement("div");
      printPage.id = "printPage";
      printPage.style.background = "#fff";
      printPage.style.padding = "20px";
      printPage.style.boxSizing = "border-box";
      
      const printStyle = document.createElement("style");
      printStyle.innerHTML = `
        #xAxis .month-label, #yAxis .decade-label {
          font-size: 0.7em !important;
          color: #000 !important;
          background: #fff !important;
          border: none !important;
          font-family: sans-serif !important;
          padding: 2px 0 !important;
        }
        #xAxis, #yAxis {
          background: #fff !important;
          border: none !important;
        }
      `;
      printPage.appendChild(printStyle);
      
      const firstName = localStorage.getItem("firstName") || "User";
      const headerDiv = document.createElement("div");
      headerDiv.style.textAlign = "center";
      headerDiv.style.marginBottom = "10px";
      headerDiv.innerHTML = `<h2>Name: ${firstName}</h2>`;
      printPage.appendChild(headerDiv);
      
      const originalGrid = document.getElementById("gridArea");
      const gridClone = originalGrid.cloneNode(true);
      gridClone.style.width = originalGrid.offsetWidth + "px";
      gridClone.style.height = originalGrid.offsetHeight + "px";
      const gridContainerPrint = document.createElement("div");
      gridContainerPrint.style.marginBottom = "20px";
      gridContainerPrint.appendChild(gridClone);
      printPage.appendChild(gridContainerPrint);
      
      const legendClone = document.getElementById("legend").cloneNode(true);
      legendClone.style.position = "static";
      legendClone.style.margin = "0 auto";
      const legendContainerPrint = document.createElement("div");
      legendContainerPrint.appendChild(legendClone);
      printPage.appendChild(legendContainerPrint);
      
      printArea.appendChild(printPage);
      
      html2canvas(printPage).then(canvas => {
        const maxWidth = 1200;
        let newWidth = canvas.width;
        let newHeight = canvas.height;
        if (canvas.width > maxWidth) {
          const scaleFactor = maxWidth / canvas.width;
          newWidth = maxWidth;
          newHeight = canvas.height * scaleFactor;
        }
        const scaledCanvas = document.createElement("canvas");
        scaledCanvas.width = newWidth;
        scaledCanvas.height = newHeight;
        const ctx = scaledCanvas.getContext("2d");
        ctx.drawImage(canvas, 0, 0, newWidth, newHeight);
        const dataUrl = scaledCanvas.toDataURL("image/jpeg", 1.0);
        
        const imageWindow = window.open('', '_blank');
        imageWindow.document.write(`
          <html>
            <head>
              <title>Life Grid Image</title>
              <style>
                body { margin: 0; padding: 20px; text-align: center; background: #fafafa; font-family: 'Inter', -apple-system, sans-serif; }
                img { max-width: 100%; height: auto; border: 1px solid #eaeaea; border-radius: 8px; }
                button { margin-top: 20px; padding: 10px 20px; font-size: 16px; background: #4361ee; color: white; border: none; border-radius: 6px; cursor: pointer; }
                button:hover { background: #3a56d4; }
              </style>
            </head>
            <body>
              <img id="printedImage" src="${dataUrl}" alt="Life Grid">
              <br>
              <button id="saveImageButton">Save Image</button>
              <script>
                document.getElementById("saveImageButton").addEventListener("click", function(){
                  var a = document.createElement("a");
                  a.href = document.getElementById("printedImage").src;
                  a.download = "LifeGrid_" + new Date().getTime() + ".jpg";
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                });
              <\/script>
            </body>
          </html>
        `);
        imageWindow.document.close();
      }).catch(err => {
        console.error("Error generating print image:", err);
      });
    }

    function openGallery() {
      galleryItems.innerHTML = "";
      let gallery = JSON.parse(localStorage.getItem("lifeGridGallery") || "[]");
      if(gallery.length === 0) {
        galleryItems.innerHTML = "<p>No saved grid images in gallery yet.</p>";
      } else {
        let sortedGallery = gallery.slice().sort((a, b) => b.timestamp - a.timestamp);
        sortedGallery.forEach(item => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "gallery-item";
          const img = document.createElement("img");
          img.src = item.imageData;
          const info = document.createElement("p");
          const date = new Date(item.timestamp);
          info.innerText = `Name: ${item.firstName}\nSaved: ${date.toLocaleString()}`;
          
          const buttonsDiv = document.createElement("div");
          buttonsDiv.className = "gallery-item-buttons";
          
          const downloadBtn = document.createElement("button");
          downloadBtn.innerText = "Download";
          downloadBtn.addEventListener("click", () => downloadImage(item.imageData, `lifeGrid_${item.timestamp}.jpg`));
          
          const printBtn = document.createElement("button");
          printBtn.innerText = "Print";
          printBtn.addEventListener("click", () => printImage(item.imageData));
          
          const deleteBtn = document.createElement("button");
          deleteBtn.innerText = "Delete";
          deleteBtn.style.backgroundColor = "#f44336";
          deleteBtn.addEventListener("click", () => {
            if(confirm("Are you sure you want to delete this saved life grid?")){
              deleteGalleryItem(item.timestamp);
            }
          });
          
          buttonsDiv.appendChild(downloadBtn);
          buttonsDiv.appendChild(printBtn);
          buttonsDiv.appendChild(deleteBtn);
          
          itemDiv.appendChild(img);
          itemDiv.appendChild(info);
          itemDiv.appendChild(buttonsDiv);
          galleryItems.appendChild(itemDiv);
        });
      }
      galleryModal.style.display = "block";
    }

    function closeGallery() {
      galleryModal.style.display = "none";
    }

    function downloadImage(dataUrl, filename) {
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function printImage(dataUrl) {
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Print Life Grid</title>
            <style>
              body { margin: 0; padding: 0; }
              img { display: block; max-width: 100%; }
              @media print {
                img { max-width: 100%; height: auto; }
              }
            </style>
          </head>
          <body>
            <img src="${dataUrl}" alt="Life Grid">
            <script>
              window.onload = function() {
                setTimeout(function() {
                  window.print();
                }, 500);
              }
            <\/script>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    function deleteGalleryItem(timestamp) {
      let gallery = JSON.parse(localStorage.getItem("lifeGridGallery") || "[]");
      gallery = gallery.filter(item => item.timestamp !== timestamp);
      localStorage.setItem("lifeGridGallery", JSON.stringify(gallery));
      openGallery();
    }
  </script>
</body>
</html>